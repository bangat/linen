<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="린넨실" />
  <meta property="og:description" content="일일 사용량에 맞게 요청 바랍니다:D" />
  <meta property="og:image" content="https://i.ibb.co/TKrjqyL/001-3.png" />
  <meta property="og:url" content="https://hallymlinen.netlify.app/" />
  <meta property="og:type" content="website" />
  <title>린넨실 요청서</title>

  <!-- 외부 CSS(기존) -->
  <link rel="stylesheet" href="linen.css" />

  <!-- 아이콘/파비콘 -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />

  <!-- 알림음 -->
  <audio
    id="notificationSound"
    src="https://drive.google.com/uc?export=download&id=1OwurEapLxRtn2I079OEjdkKxFncB35Ao"
  ></audio>

  <!-- 인라인 보조 스타일 (필요 최소치) -->
  <style>
    /* 관리자 버튼(제스처용) */
    #adminAccessBtn {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }

    /* 비활성 탭 */
    .tab.disabled {
      pointer-events: none;
      opacity: 0.5;
    }

    /* 전송 상태 메시지 */
    #statusMessage {
      position: fixed;
      top: 70%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      z-index: 999;
      display: none;
      white-space: normal;
      font-size: 14px;
    }

    /* 상단 헤더 — 여백 한 칸(기존보다 컴팩트) */
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px 4px 10px; /* 위 여백 살짝 줄임 */
    }
    .header-container h1 {
      margin: 0;
      font-size: 18px;
      flex: 1;
      text-align: left;
    }

    /* ===== 공지 마퀴 ===== */
    .notice-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin: 6px 0 8px 0; /* 상단으로 한 칸 당김 */
      border-radius: 8px;
      background: #fffbe6;
      border: 1px solid #ffe58f;
      overflow: hidden;
    }
    .notice-label {
      font-weight: bold;
      font-size: 13px;
      color: #ad6800;
      flex: 0 0 auto;
    }
    .notice-track {
      position: relative;
      white-space: nowrap;
      flex: 1 1 auto;
      will-change: transform;
      animation: marquee 18s linear infinite;
    }
    /* ❌ 호버 일시정지 제거 (요청사항) */
    @keyframes marquee {
      0%   { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    /* notice-actions 섹션 자체 제거됨 */

    /* 날짜 라벨(겹침 방지: JS로 show/hide) */
    .date-wrapper { position: relative; width: 100%; }
    .date-placeholder {
      position: absolute; top: 50%; left: 10px; transform: translateY(-50%);
      color: #999; pointer-events: none; transition: all 0.2s ease;
    }
    .date-picker {
      width: 100%; padding: 10px; font-size: 15px; box-sizing: border-box;
    }

    /* 탭 */
    .tabs {
      display: flex; justify-content: space-between; align-items: center;
      gap: 2px; margin-top: 8px; margin-bottom: 6px; /* 살짝 위로 */
    }
    .tab {
      cursor: pointer; padding: 4px 8px; font-size: 11px;
      border: 1px solid #ddd; border-radius: 5px; background-color: #f0f0f0;
    }
    .tab.active { background-color: #4caf50; color: white; }

    /* 섹션/테이블 */
    .form-section { display: none; }
    .form-section.active { display: block; }
    table {
      width: 100%; border-collapse: collapse; margin-bottom: 20px;
      display: block; max-height: 60vh; overflow: auto; /* 스크롤 대비 */
    }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; position: sticky; top: 0; z-index: 1; }
    td:first-child { width: 75%; }
    td:last-child  { width: 25%; }

    /* 입력들 */
    input[type='number'], input[type='text'] {
      width: 100%; box-sizing: border-box; padding: 5px;
    }

    /* 카메라/전송 영역 */
    .camera-section {
      display: flex; align-items: center; justify-content: center;
      flex-wrap: wrap; margin-bottom: 20px; gap: 8px;
    }
    #cameraButton, #submitBtn {
      background-color: #3498db; color: white; padding: 8px 16px; border: none;
      cursor: pointer; border-radius: 5px; display: inline-flex;
      align-items: center; font-size: 12px;
    }
    .camera-icon, .submit-icon {
      font-size: 12px; margin-right: 8px; vertical-align: middle;
    }
    #preview { max-width: 100%; margin-top: 10px; display: none; }

    /* 병동/날짜 그리드 레이아웃 */
    .form-grid { display: grid; gap: 10px; margin-bottom: 10px; }
    .form-grid--two { grid-template-columns: 1fr 1fr; }
    @media (max-width: 768px) {
      .form-grid--two { grid-template-columns: 1fr; }
    }

    /* 드롭다운 높이(모바일) */
    select {
      height: auto; overflow-y: auto; width: 100%;
      padding: 10px; font-size: 15px; box-sizing: border-box;
    }
    @media only screen and (max-width: 768px) {
      select { font-size: 16px; max-height: 200px; overflow-y: scroll; }
    }
  </style>
</head>
<body>
  <!-- 햄버거/드롭다운 메뉴 제거 (요청사항) -->

  <!-- 헤더 -->
  <div class="content">
    <div class="header-container">
      <h1 id="noticeHeader">요청서</h1>
    </div>
  </div>

  <!-- 폼 -->
  <form id="linenRequestForm">
    <!-- 병동 + 날짜 한 줄 (반반 나누기) -->
    <div class="form-grid form-grid--two">
      <div class="form-group">
        <select id="wardDropdown" name="ward" required>
          <option value="" disabled selected>병동을 선택해주세요.</option>
          <option value="낮병동">낮병동</option>
          <option value="심혈관">심혈관</option>
          <option value="내시경실">내시경실</option>
          <option value="중환자실">중환자실</option>
          <option value="인공신장실">인공신장실</option>
          <option value="수술실">수술실</option>
          <option value="면역치료실">면역치료실</option>
          <option value="응급실">응급실</option>
          <option value="방사선종양학과">방사선종양학과</option>
        </select>
      </div>

      <div class="form-group date-wrapper">
        <label for="requestDate" class="date-placeholder">입고 요청일을 선택해주세요.</label>
        <input type="date" id="requestDate" class="date-picker" name="requestDate" required />
      </div>
    </div>

    <!-- 공지 마퀴 (실시간 Firebase) -->
    <div class="notice-bar" id="noticeBar" aria-live="polite">
      <div class="notice-label">공지</div>
      <div class="notice-track" id="noticeTrack">불러오는 중...</div>
      <!-- notice-actions 제거됨 -->
    </div>

    <!-- 탭 -->
    <div class="tabs">
      <div class="tab active" data-tab="sheet">시트/기타</div>
      <div class="tab" data-tab="normal">일반 환의</div>
      <div class="tab" data-tab="ortho">정형 환의</div>
      <div class="tab" data-tab="uniform">근 무 복</div>
      <div class="tab" data-tab="inventory">재고/요청</div>
    </div>

    <!-- 섹션들 -->
    <div id="sheet" class="form-section active">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="normal" class="form-section">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="ortho" class="form-section">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="uniform" class="form-section">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="inventory" class="form-section">
      <div class="camera-section">
        <div class="button-container">
          <button type="button" id="cameraButton">
            <i class="fa fa-camera camera-icon"></i> 재고사진
          </button>
          <input type="file" id="inventoryPhoto" style="display: none" accept="image/*" />
        </div>
        <button type="submit" id="submitBtn">
          <i class="fas fa-paper-plane submit-icon"></i> 요청하기
        </button>
        <img id="preview" src="#" alt="Preview" style="max-width: 100%; display: none" />
      </div>
    </div>

    <div id="statusMessage">요청을 전송중 입니다..잠시만 기다려주세요..</div>
  </form>

  <div id="responseMessage"></div>

  <button id="adminAccessBtn">관리자 접속</button>

  <!-- 스크립트 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- 기존 js.js 유지(제출/텔레그램 등 로직이 있다면). 충돌 없게 최신화 필요 -->
  <script src="js.js"></script>

  <!-- 인라인 스크립트: 탭/공지/라벨/생성 등 핵심 동작 -->
  <script>
    // ===== 공지 렌더 함수(모듈에서도 호출할 수 있게 window로 노출) =====
    window.renderNotice = function(text) {
      const clean = (text || "").toString().trim().replace(/\s+/g, " ");
      const track = document.getElementById("noticeTrack");
      if (!track) return;
      track.textContent = clean ? (clean + "   •   " + clean) : "공지 없음";
    };
  </script>

  <!-- jQuery 초기화 (일반 스크립트) -->
  <script>
    $(document).ready(function () {
      /* ===== 데이터/표 자동 생성 ===== */
      const sheetItems = [
        { name: "대 시 트", key: "대시트_요청수량" },
        { name: "반 시 트", key: "반시트_요청수량" },
        { name: "베 갯 잇", key: "베갯잇_요청수량" },
        { name: "중 환 의", key: "중환의_요청수량" },
        { name: "이 불", key: "이불_요청수량" },
        { name: "얼음주머니", key: "얼음포_요청수량" },
        { name: "억 제 대", key: "억제대_요청수량" },
        { name: "수 건", key: "수건_요청수량" },
        { name: "검진복(하의)", key: "하의_요청수량" },
      ];
      const requiredSizes = ["3XL", "2XL", "XL", "L"];
      const sizes = ["4XL", "3XL", "2XL", "XL", "L", "M", "S"];
      const types = ["상의", "하의"];

      function populateTable(sectionId, items) {
        const table = document.querySelector(`#${sectionId} table`);
        items.forEach((item) => {
          const row = document.createElement("tr");
          const itemCell = document.createElement("td");
          itemCell.textContent = item.name;
          const inputCell = document.createElement("td");
          const input = document.createElement("input");
          input.type = "number";
          input.name = item.key;
          input.min = 0;
          inputCell.appendChild(input);
          row.appendChild(itemCell);
          row.appendChild(inputCell);
          table.appendChild(row);
        });
      }
      function generateClothingItems(sizes, types) {
        return sizes.flatMap((size) =>
          types.map((type) => ({
            name: `${size} ${type}`,
            key: `${size}_${type}_요청수량`,
          }))
        );
      }
      populateTable("sheet", sheetItems);
      populateTable("normal", generateClothingItems(sizes, types));
      populateTable("ortho", generateClothingItems(sizes.slice(1), types));
      populateTable("uniform", generateClothingItems(requiredSizes, types));

      /* ===== 헤더 클릭: 저장된 병동 복원 + 오늘 날짜로 초기화 ===== */
      const SAVED_WARD_KEY = "linen_saved_ward";
      function getTodayYYYYMMDD() {
        const d = new Date();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${d.getFullYear()}-${m}-${day}`;
      }
      $("#noticeHeader").off("click.reset").on("click.reset", function () {
        $('input[type="number"]').val('');
        var savedWard = localStorage.getItem(SAVED_WARD_KEY);
        if (savedWard && $('#wardDropdown option[value="' + savedWard + '"]').length) {
          $('#wardDropdown').val(savedWard);
        } else {
          $('#wardDropdown').val('');
        }
        $('#requestDate').val(getTodayYYYYMMDD()).trigger('change');
        $(".tab").removeClass("active").css("background-color", "");
        $(".form-section").removeClass("active");
        $('[data-tab="sheet"]').addClass("active").css("background-color", "#4CAF50");
        $("#sheet").addClass("active");
      });

      /* ===== 탭 전환(비활성 탭 무시) ===== */
      $(".tab").off("click.linen").on("click.linen", function () {
        if ($(this).hasClass("disabled")) return;
        const tabId = $(this).data("tab");
        $(".tab").removeClass("active").css("background-color", "");
        $(this).addClass("active").css("background-color", "#4CAF50");
        $(".form-section").removeClass("active");
        $("#" + tabId).addClass("active");
      });

      /* ===== 비활성 탭(요청대로) ===== */
      $("[data-tab='normal'], [data-tab='ortho'], [data-tab='uniform']").addClass("disabled");

      /* ===== 카메라/미리보기 ===== */
      $("#cameraButton").off("click.camera").on("click.camera", function () {
        $("#inventoryPhoto").click();
      });
      $("#inventoryPhoto").off("change.preview").on("change.preview", function (e) {
        var files = e.target && e.target.files;
        var file = files && files[0];
        if (!file) return;
        var blobUrl = (window.URL || window.webkitURL).createObjectURL(file);
        $("#preview").attr("src", blobUrl).show();
        $("#linenRequestForm").one("reset", function(){
          (window.URL || window.webkitURL).revokeObjectURL(blobUrl);
        });
      });

      /* ===== 관리자 이동(두 손가락 제스처) ===== */
      document.addEventListener("touchstart", function (event) {
        if (event.touches.length === 2)
          document.getElementById("adminAccessBtn").click();
      });
      document.getElementById("adminAccessBtn").addEventListener("click", function () {
        window.location.href = "admin.html";
      });

      /* ===== 날짜 라벨 겹침 해결 ===== */
      const $dateInput = $("#requestDate");
      const $dateLabel = $(".date-placeholder");
      function syncDatePlaceholder() { $dateLabel.toggle(!$dateInput.val()); }
      $dateLabel.on("click", () => $dateInput.trigger("focus"));
      $dateInput.on("input change blur", syncDatePlaceholder);
      syncDatePlaceholder();

      /* 초기 공지 UI 기본값 */
      window.renderNotice(document.getElementById("noticeTrack").textContent);
    });
  </script>

  <!-- Firebase (모듈) : Realtime Database `/notice` 실시간 구독 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        // Firebase 설정 객체
        const firebaseConfig = {
            apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
            authDomain: "hallymlinen.firebaseapp.com",
            databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
            projectId: "hallymlinen",
            storageBucket: "hallymlinen.appspot.com",
            messagingSenderId: "867775830688",
            appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
            measurementId: "G-T02ZFK18L3"
        };


    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const noticeRef = ref(db, "/notice");
    onValue(noticeRef, (snapshot) => {
      const val = snapshot.val();
      // 문자열/객체 모두 허용: 객체면 message 필드를 우선 사용
      const text = (val && typeof val === "object") ? (val.message ?? JSON.stringify(val)) : (val ?? "");
      window.renderNotice(text);
    }, (err) => {
      // 구독 실패 시 안전 처리
      console.error("공지 구독 오류:", err);
      window.renderNotice("공지 로드 실패");
    });
  </script>
</body>
</html>
