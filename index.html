<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Open Graph -->
  <meta property="og:title" content="린넨실" />
  <meta property="og:description" content="일일 사용량에 맞게 요청 바랍니다:D" />
  <meta property="og:image" content="https://i.ibb.co/TKrjqyL/001-3.png" />
  <meta property="og:url" content="https://hallymlinen.netlify.app/" />
  <meta property="og:type" content="website" />

  <title>린넨실 요청서</title>

  <!-- 외부 CSS -->
  <link rel="stylesheet" href="linen.css" />

  <!-- 아이콘/파비콘 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />

  <!-- 알림음 -->
  <audio id="notificationSound" src="https://drive.google.com/uc?export=download&id=1OwurEapLxRtn2I079OEjdkKxFncB35Ao"></audio>

  <!-- 인라인 보조 스타일 -->
  <style>
    /* 관리자 버튼(제스처용) */
    #adminAccessBtn{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:10px 20px;font-size:16px;background:#4caf50;color:#fff;border:none;border-radius:5px;cursor:pointer;z-index:1000}

    /* 비활성 탭 */
    .tab.disabled{pointer-events:none;opacity:.5}

    /* 전송 상태 메시지 */
    #statusMessage{position:fixed;top:70%;left:50%;transform:translate(-50%,-50%);width:100%;background:rgba(0,0,0,.8);color:#fff;padding:20px;border-radius:10px;text-align:center;z-index:999;display:none;white-space:normal;font-size:14px}

    /* 상단 헤더 */
    .header-container{display:flex;justify-content:space-between;align-items:center;padding:10px}
    .header-container h1{margin:0;font-size:18px;flex:1;text-align:left}

    /* ===== 공지 바(마퀴 제거, 중복 제거) ===== */
    .notice-bar{display:flex;align-items:center;gap:8px;padding:8px 12px;margin:10px 0 14px 0;border-radius:8px;background:#fffbe6;border:1px solid #ffe58f;overflow:hidden;line-height:1.5}
    .notice-label{font-weight:bold;font-size:13px;color:#ad6800;flex:0 0 auto}
    .notice-track{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1 1 auto;animation:none!important}
    .notice-actions{display:flex;gap:6px;flex:0 0 auto}
    .notice-actions button{background:#ffd666;color:#5b3a00;border:none;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer}

    /* 날짜 라벨(겹침 방지) */
    .date-wrapper{position:relative;width:100%}
    .date-placeholder{position:absolute;top:50%;left:10px;transform:translateY(-50%);color:#999;pointer-events:none;transition:all .2s}
    .date-picker{width:100%;padding:10px;font-size:15px;box-sizing:border-box}

    /* 메뉴바 (햄버거) */
    .menu-bar{position:absolute;top:10px;right:10px;z-index:1000;display:flex;flex-direction:column;align-items:flex-end}
    .menu-bar div{width:30px;height:3px;margin:3px 0;cursor:pointer;background:#000}

    /* 드롭다운 메뉴 */
    .dropdown-menu{display:none;position:absolute;top:50px;right:10px;background:#fff;border:1px solid #ccc;z-index:999;box-shadow:0 2px 5px rgba(0,0,0,.15);width:150px}
    .dropdown-menu a{display:block;padding:10px;text-decoration:none;color:#000;border-bottom:1px solid #ccc}
    .dropdown-menu a:last-child{border-bottom:none}

    /* 탭 */
    .tabs{display:flex;justify-content:space-between;align-items:center;gap:2px;margin-top:25px;margin-bottom:8px}
    .tab{cursor:pointer;padding:4px 8px;font-size:11px;border:1px solid #ddd;border-radius:5px;background:#f0f0f0}
    .tab.active{background:#4caf50;color:#fff}

    /* 섹션/테이블 */
    .form-section{display:none}
    .form-section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-bottom:20px;display:block;max-height:55vh;overflow:auto}
    th,td{border:1px solid #ddd;padding:8px;text-align:center}
    th{background:#f2f2f2;position:sticky;top:0;z-index:1}
    td:first-child{width:75%}
    td:last-child{width:25%}

    /* 입력들 */
    input[type='number'],input[type='text']{width:100%;box-sizing:border-box;padding:5px}

    /* 카메라/전송 영역 */
    .camera-section{display:flex;align-items:center;justify-content:center;flex-wrap:wrap;margin-bottom:20px;gap:8px}
    #cameraButton,#submitBtn{background:#3498db;color:#fff;padding:8px 16px;border:none;cursor:pointer;border-radius:5px;display:inline-flex;align-items:center;font-size:12px}
    .camera-icon,.submit-icon{font-size:12px;margin-right:8px;vertical-align:middle}
    #preview{max-width:100%;margin-top:10px;display:none}

    /* 폼 유효성 강조 */
    .invalid{outline:2px solid #ff6b6b}

    /* 두 칼럼 그리드: 항상 2칸(모바일에서도 유지) */
    .form-grid.form-grid--two{display:grid;grid-template-columns:1fr 1fr;gap:8px}

    /* 드롭다운 높이(모바일) */
    select{height:auto;overflow-y:auto}
    @media only screen and (max-width:768px){select{font-size:16px;max-height:200px;overflow-y:scroll}}
  </style>
</head>
<body>
  <!-- 햄버거 -->
  <div class="menu-bar" id="menuBar">
    <div></div><div></div><div></div>
  </div>

  <!-- 메뉴 -->
  <div class="dropdown-menu" id="dropdownMenu">
    <a href="#" id="adminPageLink">관리자페이지</a>
  </div>

  <!-- 헤더 -->
  <div class="content">
    <div class="header-container">
      <h1 id="noticeHeader">요청서</h1>
    </div>
  </div>

  <!-- 폼 -->
  <form id="linenRequestForm">
    <!-- 병동 + 날짜 한 줄 -->
    <div class="form-grid form-grid--two">
      <div class="form-group">
        <select id="wardDropdown" name="ward" required>
          <option value="" disabled selected>병동을 선택해주세요.</option>
          <option value="낮병동">낮병동</option>
          <option value="심혈관">심혈관</option>
          <option value="내시경실">내시경실</option>
          <option value="중환자실">중환자실</option>
          <option value="인공신장실">인공신장실</option>
          <option value="수술실">수술실</option>
          <option value="면역치료실">면역치료실</option>
          <option value="응급실">응급실</option>
          <option value="방사선종양학과">방사선종양학과</option>
        </select>
      </div>

      <div class="form-group date-wrapper">
        <label for="requestDate" class="date-placeholder">입고 요청일을 선택해주세요.</label>
        <input type="date" id="requestDate" class="date-picker" name="requestDate" required />
      </div>
    </div>

    <!-- 공지 바 -->
    <div class="notice-bar" id="noticeBar" aria-live="polite">
      <div class="notice-label">공지</div>
      <div class="notice-track" id="noticeTrack">불러오는 중...</div>
      
    </div>

    <!-- 탭 -->
    <div class="tabs">
      <div class="tab active" data-tab="sheet">시트/기타</div>
      <div class="tab" data-tab="normal">일반 환의</div>
      <div class="tab" data-tab="ortho">정형 환의</div>
      <div class="tab" data-tab="uniform">근 무 복</div>
      <div class="tab" data-tab="inventory">재고/요청</div>
    </div>

    <!-- 섹션들 -->
    <div id="sheet" class="form-section active">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="normal" class="form-section">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="ortho" class="form-section">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="uniform" class="form-section">
      <table>
        <tr><th>품목</th><th>요청수량</th></tr>
      </table>
    </div>

    <div id="inventory" class="form-section">
      <div class="camera-section">
        <div class="button-container">
          <button type="button" id="cameraButton">
            <i class="fa fa-camera camera-icon"></i> 재고사진
          </button>
          <input type="file" id="inventoryPhoto" style="display:none" accept="image/*" />
        </div>
        <button type="submit" id="submitBtn">
          <i class="fas fa-paper-plane submit-icon"></i> 요청하기
        </button>
        <img id="preview" src="#" alt="Preview" style="max-width:100%; display:none" />
      </div>
    </div>

    <div id="statusMessage">요청을 전송중 입니다..잠시만 기다려주세요..</div>
  </form>

  <div id="responseMessage"></div>
  <button id="adminAccessBtn">관리자 접속</button>

  <!-- 라이브러리 -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- 앱 로직 (외부 js) -->
  <script src="js.js"></script>

  <!-- Firebase SDK (RTDB 실시간용 / compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

  <!-- Firebase 설정 + 초기화 -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAlzPWmeLacWdnW0we7CtfnU2szvxgdIzc",
      authDomain: "hallymlinen.firebaseapp.com",
      databaseURL: "https://hallymlinen-default-rtdb.firebaseio.com",
      projectId: "hallymlinen",
      storageBucket: "hallymlinen.appspot.com",
      messagingSenderId: "867775830688",
      appId: "1:867775830688:web:cef3ed4e70ae9818f347c5",
      measurementId: "G-T02ZFK18L3"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
  </script>

  <!-- 인라인 스크립트: 공지 RTDB 실시간, 병동 캐싱, 오늘 날짜/라벨 동기화, 기타 최소 동작 -->
  <script>
    (function(){
      /* ===== 공지: RTDB 실시간 구독 + 수동 새로고침 ===== */
      function setNotice(text){
        var track=document.getElementById("noticeTrack");
        if(!track) return;
        var clean=(text||"").trim();
        track.textContent = clean || "공지 없음";
      }
      try{
        var ref=database.ref("/notice");
        ref.on("value",function(snap){
          var v=snap&&snap.val&&snap.val();
          setNotice((v&&v.text)||"");
        },function(err){ console.warn("RTDB listen error:",err);});
      }catch(e){ console.warn("RTDB init/listen failed:",e); }
      document.getElementById("noticeRefreshBtn")
        .addEventListener("click",function(){
          fetch("https://hallymlinen-default-rtdb.firebaseio.com/notice.json?t="+Date.now(),{cache:"no-store"})
            .then(function(r){return r.ok?r.json():null;})
            .then(function(j){ setNotice((j&&j.text)||""); })
            .catch(function(){});
        });

      /* ===== 병동 캐싱 ===== */
      var SAVED_WARD_KEY='linen_last_ward';
      try{
        var saved=localStorage.getItem(SAVED_WARD_KEY);
        var $ward=$("#wardDropdown");
        if(saved && $ward.find('option[value="'+saved+'"]').length){ $ward.val(saved); }
        $ward.off("change.saveWard").on("change.saveWard",function(){
          try{ localStorage.setItem(SAVED_WARD_KEY, $(this).val() || ""); }catch(e){}
        });
      }catch(e){ console.warn("localStorage error:",e); }

      /* ===== 오늘 날짜 자동 세팅 + 라벨 겹침 방지 ===== */
      var dateInput=document.getElementById("requestDate");
      var dateLabel=document.querySelector(".date-placeholder");
      function getToday(){
        var d=new Date(), y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
        return y+'-'+m+'-'+dd;
      }
      function syncDatePlaceholder(){
        if(!dateInput||!dateLabel) return;
        if(dateInput.value){ dateLabel.style.display="none"; }
        else{ dateLabel.style.display="block"; }
      }
      if(dateInput){
        if(!dateInput.value){ dateInput.value=getToday(); }
        syncDatePlaceholder();
        dateLabel && dateLabel.addEventListener("click",function(){ dateInput.focus(); });
        dateInput.addEventListener("input",syncDatePlaceholder);
        dateInput.addEventListener("change",syncDatePlaceholder);
        dateInput.addEventListener("blur",syncDatePlaceholder);
      }

      /* ===== 메뉴 토글(필수 최소) ===== */
      $("#menuBar").off("click.menu").on("click.menu", function(){ $("#dropdownMenu").toggle(); });

      /* ===== 탭 최소 동작(비활성 탭 무시) ===== */
      $("[data-tab='normal'], [data-tab='ortho'], [data-tab='uniform']").addClass("disabled");
      $(".tab").off("click.tabs").on("click.tabs",function(){
        if($(this).hasClass("disabled")) return;
        var tabId=$(this).data("tab");
        $(".tab").removeClass("active").css("background-color","");
        $(this).addClass("active").css("background-color","#4CAF50");
        $(".form-section").removeClass("active");
        $("#"+tabId).addClass("active");
      });
    })();
  </script>
</body>
</html>